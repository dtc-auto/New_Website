# -*- coding: utf-8 -*-
from __future__ import unicode_literals
from django.http import HttpResponse
import urllib.request
import urllib.parse
import urllib
import pandas as pd
import time
from templates.dashboard.Connect_DB \
    import getCarOwner, getColumnChart_p1, getLevel1Attributes, getLevel2Attributes, getPurpose, people_get_pie, people_get_path, CP_get_cluster, \
    Config_get_config_local, Config_get_company, Config_get_model, Price_get_company, Price_get_specl, Price_get_pricel
import json
from django import forms
from django.shortcuts import render,render_to_response
from django.contrib.auth.decorators import login_required
from django.contrib.auth import authenticate, login


class UserForm(forms.Form):
    username = forms.CharField(label='username', max_length=50)
    password = forms.CharField(label='password', widget=forms.PasswordInput())


def my_login(request):
    # next__ = request.get[next]
    if request.method == 'POST':
        userform = UserForm(request.POST)
        if userform.is_valid():
            username = userform.cleaned_data['username']
            password = userform.cleaned_data['password']
            user = authenticate(username=username, password=password)
            if user is not None:
                if user.is_active:
                    login(request, user)
                    return render_to_response('dashboard/index.html', {'userform': userform})
                    # return render_to_response(next__, {'userform': userform})
                else:
                    return HttpResponse('wrong username or password, please re-input')
            else:
                return HttpResponse('wrong username or password, please re-input')
        else:
            return HttpResponse('wrong username or password, please re-input')
    else:
        userform = UserForm()
        return render_to_response('dashboard/login.html',{'userform':userform})

# @login_required
# def my_logout(request):
#     request = render_to_response('dashboard/login.html')
#     #清除cookie里保存的username
#     logout(request)
#     return request


# index page
def index(request):
    return render(request, 'dashboard/index.html')
# car dashboard page
@login_required
def carOwnerChartPage(request):
    return render(request, 'dashboard/carEchartPage.html')
# people dashboard page
@login_required
def peopleChartPage(request):
    return render(request, 'dashboard/peopleEChartPage.html')
@login_required
def LTPChartPage(request):
    return render(request, 'dashboard/LTP_Page.html')
@login_required
def CPChartPage(request):
    return render(request, 'dashboard/CP_Page.html')
@login_required
def ConfigChartPage(request):
    return render(request, 'dashboard/ConfigPage.html')
@login_required
def priceChartPage(request):
    return render(request, 'dashboard/pricePage.html')

# get car page data
# @login_required
def carOwnerChart(request):
    # page 对应原页面 page 1-4
    target = request.GET.get('a', '')

    # 当 select 所有车型的时候进入 page_2_lv1
    if len(target) == 32:
        page_2_lv1 = getLevel1Attributes(target)
        dict = {'page_2_lv1': page_2_lv1}
        return HttpResponse(json.dumps(dict), content_type='application/json')

    # 当 select 包括维度时进入 page_2_lv2
    if len(target) >= 6:
        page_2_lv2 = getLevel2Attributes(target)
        dict = {'page_2_lv2': page_2_lv2}
        return HttpResponse(json.dumps(dict), content_type='application/json')

    # 当 select 单个车型时进入 page_1_map / page_1_stacked / page_2_lv1 / page_4_purpose
    page_1_map, map_max_data = getCarOwner(target)
    page_1_stacked = getColumnChart_p1()
    page_2_lv1 = getLevel1Attributes(target)
    page_4_purpose = getPurpose(target)
    dict = {'page_1_map': page_1_map,
            'page_1_map_max_data': map_max_data,
            'page_1_stacked': page_1_stacked,
            'page_2_lv1': page_2_lv1,
            'page_4_purpose': page_4_purpose}
    return HttpResponse(json.dumps(dict), content_type='application/json')
# get people page data
# @login_required
def peopleChart(request):
    target = request.GET.get('a', '')
    path = request.GET.get('path', '')

    # 当 select path 时进入 people_get_path
    if len(path) > 0:
        path = people_get_path(path)
        dict = {'path': path}
        return HttpResponse(json.dumps(dict), content_type='application/json')

    pie_data = people_get_pie(target)
    dict = {'people_get_pie': pie_data,
            }
    return HttpResponse(json.dumps(dict), content_type='application/json')

# get LTP
def LTPChart(request):
    text = request.GET.get('a', '')
    text = urllib.parse.quote(text.encode('utf8'))
    # 词性url
    url_pos = "https://api.ltp-cloud.com/analysis/?" \
          "api_key=C1H4c7k3j9LIApERArIRNF7ARHKRIPdqWI9xhMue&" \
          "text={0}" \
          "&pattern=pos" \
          "&format=plain".format(text)

    result_pos = urllib.request.urlopen(url_pos)  # POST method
    content_pos = result_pos.read().strip().decode('utf-8')
    content_pos_list = content_pos.split()
    return_text_pos = ''
    for i in range(0,len(content_pos_list)):
        if '__' in content_pos_list[i]:
            word = content_pos_list[i].replace("__", "_ _").replace(" _", "(")
        else:
            word = content_pos_list[i].replace("_", "(")
        word += ')  '
        return_text_pos += word

    # 分词url
    url_ws = "https://api.ltp-cloud.com/analysis/?" \
          "api_key=C1H4c7k3j9LIApERArIRNF7ARHKRIPdqWI9xhMue&" \
          "text={0}" \
          "&pattern=ws" \
          "&format=plain".format(text)
    result_ws = urllib.request.urlopen(url_ws)  # POST method
    content_ws = result_ws.read().strip().decode('utf-8').replace(" ", "    ")
    return_text_ws = content_ws
    r_dtc = {'pos': return_text_pos, 'ws': return_text_ws}
    return HttpResponse(json.dumps(r_dtc), content_type='application/json')

# get CP
# @login_required
def CPChart(request):
    # r_dtc = pd.read_csv('../dashboard/static/plot.csv', usecols=['value', 'slevel'], encoding="gb2312")
    data_cluster = CP_get_cluster()
    dict_ = {'cluster': data_cluster}
    return HttpResponse(json.dumps(dict_), content_type='application/json')


# 配置参数
# get Config_company
# @login_required
def ConfigCompany(request):
    id_ = request.GET.get('id', '')
    pos = Config_get_company(id_)
    return HttpResponse(json.dumps(pos))

# get Config_series
# @login_required
def ConfigSeriesChart(request):
    id_ = request.GET.get('id', '')
    content_pos = Config_get_model(id_)
    return HttpResponse(json.dumps(content_pos))

# get Config_modle
# @login_required
def ConfigModleChart(request):
    id_ = request.GET.get('modelId', '')
    content_pos = Config_get_config_local(id_)
    return HttpResponse(json.dumps(content_pos), content_type='application/json')


# 二手车价格
# get Price_company
# @login_required
def PriceCompany(request):
    id_ = request.GET.get('id', '')
    pos = Price_get_company(id_)
    return HttpResponse(json.dumps(pos))

# get Price_series
# @login_required
def PriceSeries(request):
    id_ = request.GET.get('id', '')
    content_pos = Price_get_specl(id_)
    return HttpResponse(json.dumps(content_pos))

# get Price_modle
# @login_required
def PriceModleChart(request):

    dit_price = {'20.87': [1.56498915663008, 0.04939441225288088, -1.1415313886240537, -2.3710332239235976, 5.6518647028247884], '21.52': [1.7114970615864278, 4.440892098500626e-16, -1.3130082630491473, -2.87126061270843, 6.892737492173632], '21.69': [1.895315455844715, 0.2471761778254722, 10.84391068265755, -3.557374734553655, 2.0833191065784433], '22.23': [2.340189750020853, 0.0, 3.7615442222105675, -4.889870046480513, 8.7964426524908532], '22.77': [1.8651913067986605, 5.773159728050814e-15, 9.363124596743004, -3.683223079750803, 8.8049086337261357], '23.4': [1.8203780186500367, 0.0, -1.2095386357673894, -2.3094903129909774, 7.4186320368279812], '24.05': [1.9645237852213406, 0.0007245078607049926, -1.3542451751239126, -2.7011745762760704, 7.6196282927596517], '24.4': [1.7841628218672907, 8.881784197001252e-16, 11.572653614067987, -2.7311869360124406, 9.9906312520276206], '25.49': [2.0741673534210108, -0.20212227798657745, 8.606137924839764, -4.003340150421542, 16.050518653783996], '25.56': [1.9678557500159712, -0.4893131116885985, -1.295128833576706, -2.737685671381266, 20.597422629363244], '27.12': [1.8291702299872599, -0.3862029323379401, 12.25839623675552, -3.1218805754168484, 22.380449331994619], '27.41': [2.197417912015972, -0.1990478356165184, -1.418653741856518, -3.2934342862171486, 14.101341066844771], '27.68': [2.1098349649229164, 0.223018919489963, 17.457446577631888, -3.950869180841144, 4.3770487050873594], '28.2': [1.9522176676595568, -0.10580003907504842, 11.620052430352173, -3.76740453219621, 15.702562180814477], '29.09': [2.126232389000685, -0.12123867807718014, 19.767446628796, -3.2131801792830896, 14.241120958925677], '29.29': [2.3716062788409786, 0.005570940673596425, 14.618194177228462, -5.139800157866027, 10.834351757479467], '29.5': [1.998241129571876, 8.881784197001252e-16, 13.283109611044939, -3.656468424842459, 13.443837947031255], '30.37': [2.4129942410804017, -0.3410727307475838, 14.474810638932032, -6.466330762031766, 22.278098071230545], '31.37': [2.247063045165315, 0.5081834209574714, 20.692031687555453, -2.9530849943528388, -3.8653417729981037], '31.46': [1.9318946692018348, -0.08746903796089, 13.3527113453382, -3.424123024361908, 17.7355465178006], '32.54': [2.050721105637316, 0.06824861024985651, 12.093404301184423, -3.7983604963913056, 14.128538743520059], '33.43': [0.6685147664783034, -1.7763568394002505e-15, 5.971721541667831, 0.1624129466628543, 27.091183625189981], '33.54': [2.1926147542273617, 3.9968028886505635e-15, 21.362379391995077, -3.2532869621964156, 13.725597228022972], '33.84': [1.9918379344462291, 0.1195700410998457, 13.504899276527086, -3.962194130426236, 13.53740339620234], '34.71': [3.366742840835031, -0.04047566188801355, 12.086336775123561, -9.246927280380161, 14.766763365961914], '35.2': [2.5302244940647483, 0.09486485440530856, 15.004021949414904, -5.93765667470067, 13.161100540738397], '35.26': [3.5375639737555478, -0.18323072266974094, 11.693010133983135, -12.838927852838214, 20.179833199210211], '35.6': [2.2701793411633897, 0.07721213703015062, 21.758920257628475, -2.607346694333051, 12.576541821667433], '36.2': [0.8316380025641451, 0.3692132721922756, 8.432838328564129, 0.4543738227394873, 14.420511056853465], '36.29': [2.6503433703251584, -0.16898553944935735, 14.852496230344386, -6.853171913125915, 23.536572183938517], '37.83': [0.6472475454423018, -2.220446049250313e-16, 5.559066133313718, -0.12593738132762944, 31.733371356728153], '39.62': [0.6716678054358091, -0.06816911580410356, 5.59924678279895, -0.06579249590098687, 36.159615581780542], '40.0': [0.7849894249304401, 0.0, 7.3089012632798465, 0.28294635186718353, 32.503488394962972], '40.14': [4.0737865479506095, 0.20495738496472526, 9.298129660920603, -10.13411772392378, 7.4046500767271546], '40.92': [2.7058759862845365, 1.7763568394002505e-15, 20.201211845535816, -3.179904984693769, 18.042687079824205], '42.93': [0.7214077745281445, 0.18926045849948214, 6.000347257318311, -0.19031793394717322, 28.189432120681673], '43.2': [5.536587207296991, 1.7763568394002505e-15, 2.7237170670994053, -10.424414287483621, 12.134887058250532], '43.4': [4.703116343816034, 0.2378672327055149, 9.03661331758723, -9.428250073677203, 5.3140687993978553], '44.27': [4.248468996974743, -0.050608234756840176, 15.264352021763143, -11.389463009598705, 19.322728299670931], '45.06': [0.7725011807206198, -0.13133312298935929, 6.290873482918839, -0.06346907206621318, 44.033265804086795], '46.0': [5.4585125000387125, 0.0, 3.4024024647631346, -10.321201597392799, 15.83154468802141], '46.46': [1.0239686882170898, 0.0, 8.449877105904658, -0.8851379464795305, 37.527779280668845], '46.54': [4.065523840138526, -1.7763568394002505e-15, 14.241966595477013, -5.923430948509626, 18.093083253122536], '46.63': [0.789178486511784, -0.6045830317904624, 6.540064020246473, -0.08403142613980637, 67.632923131962144], '46.65': [5.2796903919599325, -0.1074181590804617, 7.9712337409810035, -8.263643337648006, 22.723823120082965], '47.32': [0.9913876408346718, -0.14083417783047736, 9.225235905580973, 0.3167495910535647, 44.579464739188353], '49.26': [6.403303252911416, -0.08389502906929458, 3.0766554292288517, -11.265854942414315, 17.972076402814697], '49.39': [2.839834156910832, -0.20264472673305356, 21.48034782072609, -3.1170265595585995, 35.172850352076857], '49.69': [5.629888613962107, -0.02450802964029819, 5.408935121884748, -9.663739350782246, 18.328062360093544], '49.8': [5.302747810904482, 0.0, 8.238983976056764, -8.869305540796315, 20.112335728955543], '49.91': [5.768289878027647, 0.02545568640464957, 2.5228771308651115, -10.209241364776174, 17.12412918624673], '50.89': [5.964889872372514, 0.17411600904226354, 4.401076319994542, -12.488686305537566, 8.5209692079049084], '50.98': [0.7874715018714693, -0.418204429955712, 6.481757788497895, -0.22970031862353993, 65.056693487597514], '51.0': [3.888714661089359, 7.105427357601002e-15, 24.14949687610517, -7.212326859686874, 20.337260169394192], '51.99': [2.8707253378653705, -0.22984384601161834, 22.38620725516463, -2.205857438124576, 38.936565246786984], '52.65': [1.707528601536518, -0.1648184359823307, 14.573883298158501, -1.2903770127931034, 46.745007118716906], '53.17': [3.9737735021202987, -0.08206026020528778, 32.555409936793176, -5.8213650969247555, 23.208654437281609], '53.19': [1.6346267763300981, 0.33978176242743086, 14.709703674505485, -1.3390022215691268, 20.409607164959031], '53.54': [0.771188588958179, -0.2568638700312169, 6.409304592885862, -0.052259411862305316, 60.014162304298637], '53.61': [3.039094583024242, 0.3260911669280846, 33.53508620025934, 1.6593102610900299, 5.825981380943837], '53.75': [0.8250111872630893, 5.551115123125783e-17, 6.440916358402018, -0.24460829187343075, 46.445280785272892], '54.03': [6.993600286641911, -0.08693223204315181, 3.65554223445438, -11.59410175777303, 19.84384851866762], '54.25': [4.560938880979284, 0.0, 17.151753152491548, -6.322607472054402, 21.786337741619409], '54.37': [1.116337789231515, 0.7873862375851877, 10.683240071416654, 0.37511965527775604, 0.76807933492393232], '55.03': [1.1212177840255024, 0.11876988620569451, 10.84984055320198, 0.4960630189186227, 37.562713074563227], '55.25': [4.168973528946379, -3.552713678800501e-15, 43.18133873443397, -1.8180148800184897, 15.919121937834163], '56.03': [0.8100035393162783, 0.13191148057121405, 6.537716468170703, -0.21563611313689607, 41.214332702288722], '56.21': [7.149993154591047, 0.056530156539638554, 3.4341079348357835, -15.821876328692609, 12.778967483622328], '56.34': [3.6531460466661003, -0.06798971823981503, 31.425483431543405, -4.311536929763974, 28.706943185826542], '56.41': [4.026024784831727, -0.049814089899413716, 27.913520397616374, -6.112173769663058, 25.129296508289091], '56.42': [5.558401777810328, 0.01403748894012935, 18.860631341055548, -12.420951940896977, 18.704191190870635], '56.55': [1.0970047316202487, 0.076282530601675, 11.04338765004516, 0.46526082458693996, 41.043272801954714], '56.99': [4.396292661060598, -0.5343088261623476, 25.884577463112127, -4.321548862859421, 53.950576599777676], '57.31': [3.284824616252225, 0.022900129075942743, 35.876727420203025, 1.5850343854151099, 23.631821878081674], '57.46': [3.8112486463908133, -0.11386754688706802, 21.239992106397548, -8.997115487120752, 34.63531407769355], '57.86': [3.587967942764285, -0.8856445394751642, 26.87117642316239, -4.734473098815689, 79.310723187139416], '58.07': [4.159056080317384, -0.03889213910767886, 21.71148573892703, -8.323658015579436, 30.530589951936559], '58.18': [3.6259621714608934, -0.1858864596709342, 26.995738262014523, -5.592625168452432, 39.147915347685384], '58.51': [3.4842945887678636, -0.8452794034436639, 31.155958055188, -3.1922991150438267, 77.06449228407584], '58.8': [0.8439790520393259, 0.32830746035987907, 6.56614169875647, -0.2827946862277544, 31.966777791745695], '58.92': [5.2703421815747795, 0.017973222403242062, 18.447271627988425, -9.87219350863427, 22.130967393978224], '59.15': [4.160874463243178, 0.17929566926693674, 28.594249238546986, -5.6623421745461515, 13.521379611386848], '59.27': [3.9159099173580816, -0.2732514046163086, 32.81474939932614, -1.4012803983876285, 42.765769222317516], '59.35': [7.179650925780889, -0.07296207649784847, 4.1286217599018835, -13.663833380890589, 24.847995189154499], '59.57': [6.016171018663179, 0.13386754402701762, 9.423285199881326, -12.810689801617581, 17.408072251874394], '60.24': [4.2435062727886805, 0.12045852694179704, 45.565696836910526, -1.806993900198839, 11.290138390576193], '60.29': [4.054435693747487, 0.08366589920010625, 22.608912833747766, -7.50506589461456, 24.320893429049804], '60.44': [5.920089628936171, -0.01637539759661344, 9.708129000430642, -10.156298725533938, 26.951379862976985], '60.55': [7.82769457934318, -0.039671894867314705, 3.705053773190817, -18.483680858318227, 19.623793072460458], '60.68': [1.1893842006421669, -0.17403381573525012, 11.8336017573336, 0.4112842373439883, 59.220265229051677], '60.76': [7.241726148813123, 0.06313144610407662, 3.2980850248190627, -19.015652802570546, 17.50897603336427], '60.79': [3.7911559304026192, -0.030848376863561455, 27.877581317425953, -5.652558622626932, 31.807334605526435], '60.89': [3.9809285724257717, 0.7576508757861848, 22.80017496699281, -7.807351759126199, -16.323210412546757], '61.11': [3.672369665193822, 0.0029083681427675145, 28.34599062827335, -5.7202977505016985, 29.829291276604664], '61.33': [4.2481812647371315, 0.46302423803177106, 23.457738492129288, -6.406382367304694, -1.8426349099801271], '61.44': [3.764375914716979, 0.21062653463544478, 28.00832465883573, -6.0379061515616375, 17.393927192150024], '61.65': [3.3455057435703197, -0.1281872080149835, 37.06381098356395, 1.5014723870550106, 36.078593941570972], '61.85': [6.735991496507264, 0.03730149649530823, 10.215984987442162, -13.357859286308136, 21.667331599770606], '62.63': [4.122546800504034, -0.036013371133917005, 41.68419430526739, 0.5473524041200636, 25.104448156747168], '62.74': [4.102464685917883, 0.6588339995337353, 28.97255006638929, -3.322821717034196, -14.117422685333047], '62.96': [3.4024734095759146, 0.1730440053560276, 29.65275211193413, -3.014215388998707, 23.009077783249985], '63.5': [4.177821827708415, 8.881784197001252e-16, 31.94886009474296, -3.5737206945518984, 27.167724951659928], '63.61': [6.183391010252915, -0.03593155150435656, 10.474802955339165, -11.150756123297256, 29.600542189856789], '63.7': [7.50074691025441, -0.06239542842705603, 4.093411310958538, -15.306146997306339, 26.20987298717051], '64.13': [5.127150146940475, 3.552713678800501e-15, 18.398603553328012, -10.686520891452625, 27.487401835999471], '64.26': [3.930564449875663, -8.881784197001252e-15, 33.96387799855323, -6.360547524374094, 30.183149692503008], '64.9': [4.395866975604509, -0.14927181756978491, 30.259515756016796, -4.96791108048765, 37.947840156373154], '64.91': [5.834540693519003, 0.5779217322363035, 19.864980762100373, -9.948777355553458, -10.114983377434072], '65.11': [6.231250200190214, -1.7763568394002505e-15, 8.335963573173796, -11.56018728760134, 23.126204949728127], '65.66': [4.682062031452059, -0.14511577181400703, 29.688002087942518, -5.706494784414797, 38.379977055737683], '65.89': [3.2972748885605974, -1.7763568394002505e-15, 30.765076386463523, -3.2171400186761243, 35.661011544190359], '66.0': [3.9869525021479455, 7.993605777301127e-15, 31.8833636627316, -4.680423940984184, 29.927398109879512], '67.06': [5.399674917390775, -0.09898979184682943, 19.26458333096501, -10.862839435921648, 36.017331319067779], '67.07': [4.437718407585814, -0.09108684149199231, 30.926238041580923, -4.522024078757564, 35.83060961095866], '67.49': [5.615728429608269, 3.552713678800501e-15, 19.73641669843684, -10.233459720737702, 29.597080538001677], '68.17': [5.217333779938976, 0.2366024451770432, 28.76596827166725, -7.373891847201365, 12.336368999023477], '68.38': [4.223229748117891, -8.881784197001252e-16, 37.29025717372021, -1.4084448226468544, 30.138320230938689], '68.93': [4.368493136986685, -0.05566526349659595, 43.49686568669597, 0.36665367769171664, 31.172758973964434], '69.25': [3.922747923561449, -3.552713678800501e-15, 33.6150538097875, -3.1567966056748795, 35.029911133135037], '69.47': [3.348773339531358, 0.2534052570128993, 37.43116767861939, 1.6893779520498153, 17.598284212558308], '69.77': [9.01934842568458, 0.2253061447686875, 5.293156575021041, -16.947878120722223, 3.8972586791013448], '70.01': [4.683934245549604, 0.24888540901216594, 46.95847230786393, -2.1527145911908505, 9.5528913903185924], '70.33': [4.234333406388176, 0.5497799945110886, 31.19841867579191, -5.358796280741268, -6.7101608003652586], '70.54': [3.9662368760928333, -0.29834420654065674, 33.9857645910949, -2.7032170986741995, 54.462092508884979], '70.56': [1.5478331329666881, -0.1948146114720819, 13.039025641563411, -1.3446212976146716, 70.578560098292812], '71.42': [6.914632017232633, 0.15296021461059794, 19.166321338245368, -10.81868153577632, 18.351942528678837], '71.51': [7.932591886135985, 0.17624854851683303, 5.509406214008657, -16.79828567912144, 13.491675172960811], '71.53': [3.7136054078885787, -0.2682597489695393, 39.04730492114806, -2.815256918885435, 55.90708294048504], '71.64': [4.074648712545559, 0.0, 38.095732680973235, -0.5485097711367393, 32.621782555856086], '71.86': [4.426381644490171, -5.329070518200751e-15, 38.269986967551155, -5.368528134272394, 34.501557374447735], '72.51': [8.69019194060374, 0.16812752961616084, 5.477230035661974, -21.521043439618772, 15.084595830577193], '72.73': [3.63017935120409, 0.40586653344405477, 39.85678782890516, 1.7584776089438392, 6.8845300736389703], '73.59': [4.248060057674144, -2.6645352591003757e-15, 45.84610358193211, 0.7256203236466856, 29.721273330385358], '73.68': [8.868306060030584, -0.10129261355251984, 4.494145420108664, -16.10187940963341, 29.226449136543167], '73.8': [4.21037800078045, -0.042111756752047924, 35.338780845488266, -3.2393633648899987, 38.119377194843366], '74.01': [7.481208680874456, 0.30129289209818566, 12.717713464035278, -17.23083960605448, 9.0182534709144448], '74.9': [1.6037170843972839, 0.0, 13.865519982130817, -1.5442476503549458, 60.316623901804128], '75.77': [5.630419362025313, 1.7763568394002505e-15, 46.552420285029214, -10.930796562224394, 29.007933051385834], '75.85': [8.559579343597482, 0.0, 5.437625363010532, -18.655400887257837, 28.476021123320564], '75.87': [7.178589107645261, 2.6645352591003757e-15, 12.816227075957396, -11.539196361945669, 34.439246178717283], '76.53': [3.8895117333432325, -0.3755221598558789, 42.24130889734636, -2.214460852622366, 67.93648717043304], '76.85': [6.045575770633958, -0.1747829285397735, 21.48857886168501, -10.322886003789522, 47.128999617874676], '77.94': [4.877875205976218, 0.35179337200763783, 60.11169929320057, 3.868569526769028, -1.574184204180078], '78.02': [9.672718455976144, -0.24403355407378413, 5.0279753737333355, -15.422812212177325, 41.96221662409998], '79.02': [5.3335701313887345, -0.2841548089878039, 53.64915420446557, -7.179972144455234, 53.474538341377517], '79.22': [7.333678182483737, 0.281699434748532, 12.77163124775622, -16.05244332250244, 13.650773861594544], '81.41': [1.2960921170606248, -2.220446049250313e-16, 11.863280758862071, -0.3844762129616708, 69.339106344435308], '81.82': [6.969469619740178, -0.03252997210687525, 7.393907102879354, -13.938342072547991, 32.337474535038837], '82.28': [5.654044871499645, -0.018218021594945455, 31.989905981988578, -7.255248530810394, 37.893123168169964], '83.04': [1.4955107298503458, -0.9361273908632675, 16.180670598015126, 0.1180923592456, 145.49518798441068], '83.58': [1.3199238064488978, -2.220446049250313e-16, 11.88149973928712, -0.5149958244453084, 71.444831345283148], '84.67': [1.856269355044951, 5.773159728050814e-15, 16.20584083642613, -1.8698812654230907, 67.800697020369341], '85.62': [6.302966642476972, 0.07328606380673719, -2.4729420786419647, -10.676610637716758, 25.850049963491671], '86.71': [9.070790313857833, 0.0008513124026592322, 17.74365535090484, -20.135292601123552, 32.628988080646835], '86.84': [5.274215453980651, 0.0, 64.2136684565647, -0.10475379543664946, 31.994290704177715], '87.25': [11.477856724586797, 0.0, 4.709859574015045, -23.312273557427893, 25.810328496143534], '88.47': [5.835075448970012, 0.12133001884894767, 69.72304753588523, -2.4258863356443805, 18.434554933311034], '88.79': [6.990643247917234, 0.2890909718626684, 30.85908799969669, -14.572468269541286, 10.735454608872921], '89.12': [5.955009264265527, -0.2624225400040352, 57.592412313718306, -5.000534167593901, 58.115560182366167], '89.77': [6.834689712001886, 0.1595870660839367, 41.46427652742667, -12.649502090974782, 23.443723474604145], '89.88': [7.29466635237811, 0.03414135785870975, 39.62175967566402, -15.588910509280904, 34.910107983050565], '92.03': [6.519660300042665, 0.16266272120119218, -2.66248367573402, -12.19051400903603, 19.331178477098298], '92.05': [6.8721399847173075, -0.010432765547544243, 34.94322727191454, -10.113440563745428, 39.686065123520251], '92.89': [9.691788231186216, 0.08505860255006326, 18.048813376950744, -18.982008480540326, 28.196616713158789], '93.13': [5.642052078669932, 0.0, 28.98693000912125, -3.649166878084874, 48.878071510857758], '93.35': [1.9328060049736657, 1.7763568394002505e-15, 19.700466196170705, -1.781292700977931, 75.541387720410228], '94.54': [6.4718130263611915, 0.17359407524051917, 53.26529978487268, -9.144527688124848, 26.090025152697756], '94.96': [8.288312440960928, -0.03454911849246045, 30.75989408676082, -12.956693909624658, 44.985433907974965], '94.98': [6.724004990429754, -0.25455811727014144, 71.08363800752932, -1.3462338928988489, 59.230454465502554], '95.09': [6.092379906533328, 1.1102230246251565e-14, 75.0796210330985, 0.6388346343519338, 32.177589253688005], '95.5': [9.211689424719825, 0.0, 24.978007929222446, -20.45047591869258, 40.179188002114252], '95.63': [6.3476159751090915, 0.054112596217901654, 59.05163229665597, -7.80322325384921, 34.354520714382652], '96.17': [6.190496085301878, -0.05753363395726119, 59.03568139868631, -6.146264597793868, 45.449698609575428], '97.37': [7.628599399694468, -0.1132828186436452, 29.899954380687934, -14.161106049442347, 55.312426688580359], '97.45': [7.13464175725712, -0.058350741400700734, 43.320926237252266, -11.940844153783923, 49.311866446796891], '97.48': [8.963538965849061, -0.09094369194442109, 2.1383057691831944, -22.990701948850887, 47.598344713166355], '97.58': [2.5833226944768346, 0.4972400123952654, 27.602945403401755, -1.6077366172204839, 25.087475883886448], '97.67': [10.567673934444088, -0.30073152892092025, 18.664059068226454, -31.812828910309246, 72.115511914374991], '98.0': [6.816930117730814, -3.552713678800501e-15, 42.909766908473465, -11.773012389382576, 44.241731259588789], '98.76': [7.0840274346995775, 0.1275728355819652, -2.5794592925176323, -11.89399933436352, 24.043923312503935], '99.75': [6.599680022877931, 1.7208456881689926e-14, 76.93376016413822, 0.46588736628269517, 35.313782460601203], '100.6': [9.339253069241565, 0.1178664909377023, 24.822496728922157, -21.567704615943065, 31.89806520987408], '100.71': [10.015628542225233, 0.15756681980633047, 8.045555936553596, -20.916677409825507, 28.289423685384797], '100.73': [5.28718575416624, -0.4076798986015966, 59.823086765001825, 12.4121125635618, 88.899051636728672], '100.82': [10.504907515635463, 0.02820444143775447, 6.110592787743052, -22.772055858150516, 41.147994249399943], '100.93': [10.602725759808484, -0.10040732108117112, 19.3441957230615, -23.842657709382916, 49.481485822999659], '101.06': [6.25233861886245, -0.1455215163079373, 54.34751449886309, -12.300244412032473, 62.600677976615742], '101.6': [4.078708845871477, -7.105427357601002e-15, 49.096508500370255, -2.1315626756813857, 61.059332808084179], '101.71': [10.462401818479929, -0.1278334424469172, 7.407371021913331, -22.214390734415833, 57.772738339594625], '101.82': [9.77234344525811, -0.08501585693640124, 23.998345117569194, -24.25973149561767, 54.002378551651105], '102.01': [8.55323567462605, 0.2799520665944275, 32.017201318015, -17.368774347875604, 17.758787073206996], '102.9': [6.570171639581324, 0.003548877434610631, 77.6834425577069, 0.5302050555623647, 36.812874336992984], '103.12': [5.164769595062056, -0.17014632092631032, 66.90458472531904, -1.9481492047241715, 66.483824495778606], '103.66': [6.418017309098447, -0.20388734292877153, 60.50673625066005, -6.384960986111357, 67.256511133965262], '103.78': [6.43831312525708, -0.4595865355494304, 78.1849171404376, 1.3022382166524284, 85.994685919378384], '103.89': [6.482138027461621, -0.08881771979415642, 78.09804040399341, 0.734288615919175, 47.653003926086285], '103.99': [4.900520704314431, -0.3897294696818241, 54.38671393430215, -4.566980235723052, 93.692237675321252], '105.07': [6.187612829841028, 0.09198847961221546, 75.17691272528621, 0.28598671447095303, 31.25019193118337], '105.29': [5.665516384313346, 0.13047700490488623, 68.91802306231902, -2.0095083954193274, 35.661391236806367], '105.49': [7.053274916392274, -0.3587874248846745, 43.975947633483216, -13.761625824971025, 88.007285570937952], '106.29': [4.250388140361986, -0.33356076195177486, 49.90304240428937, -1.42325476058799, 100.46445442046225], '106.38': [5.743923740458498, 0.37271884864828486, 74.63101655991869, 1.9530088023667855, 2.8017687812196996], '106.48': [6.015511590264923, -0.23258931924057613, 54.453030716054215, -12.26308146064243, 78.238088649886137], '106.97': [4.204633731238518, 0.129155057632504, 49.92058723868816, -1.8508326889323792, 51.833585233228298], '108.33': [6.4512579181052425, -0.12246407284014538, 65.95837779187586, 3.6040689527300724, 63.192016560875274], '108.53': [10.673055138418857, 0.15066561133821033, 6.059531456742206, -19.75905435336025, 19.91143738324741], '108.66': [5.85913989355244, -0.04639388772751829, 55.58340755941057, -11.153051289870666, 59.489578566436549], '110.72': [6.345026262424014, 0.0273084234527321, 74.66310628014426, 0.6564937024773311, 43.865979855340768], '110.73': [6.902246150817593, 0.12220092644954228, 81.65911837357794, 0.9846535084401267, 28.70946009512938], '110.94': [9.372801300974606, -0.07342613397131004, 28.18628965180004, -21.811394929955448, 56.91395872619929], '111.66': [4.440104982099295, -0.18356222045718695, 52.029958526754555, -2.316182969826586, 89.041533752191796], '111.67': [10.999351969384476, -0.4303510739456833, 8.295663199109587, -24.38847327010471, 97.521139802189566], '112.78': [11.87583091991609, -0.1729599454960642, 9.98649770863695, -23.156324103502147, 68.990977571635412], '112.89': [5.976659398497797, -0.3279990574978022, 72.49310733428172, -2.4504931096688085, 91.024642917986341], '113.52': [6.5632977933258845, 0.4704058867384102, 63.86395611199451, -5.523251875654898, -0.23063367345946517], '113.84': [7.950152619957999, -0.20326610998232653, -2.641522798398034, -14.327007214356335, 68.923867253665065], '114.17': [7.935313904947769, 0.25723953911016295, 46.02738399465394, -12.846909323881436, 27.484463279906237], '114.84': [6.347880438226993, -0.28711071699741897, 61.72844895571108, -2.264194838849092, 89.9305095836188], '118.1': [6.504333779760623, -0.10548336740227882, 78.02211239717634, -0.1555057803618104, 63.986503797332993], '118.32': [6.456722029176408, 0.1798008480093305, 55.41477336135179, -12.971071382728407, 42.702047700747848], '118.86': [6.6963853414141425, -0.35877817211869356, 63.75008025910899, -5.054584175214248, 100.98125355266289], '119.18': [8.527829123309608, 0.016859843784862605, 52.108039445114144, -20.858493571077215, 51.568985561755561], '119.27': [12.606813318811241, 0.29520310492614854, 22.891288091124544, -26.11393723900309, 13.201703101153662], '119.4': [1.9239259893438387, 0.25525539856668555, 17.086289486289918, -0.5517763201071432, 71.472988277269508], '120.05': [6.171554822511056, -0.5055562985873046, 64.2095348023173, -5.830463018116273, 119.8361227954842], '120.27': [6.915738141090027, 0.6379844785677538, 59.10755988735163, -11.011232003189578, -13.662994542544993], '120.68': [7.339339500727112, 0.03154391615787233, 45.628128404459815, -15.40954081921429, 59.481885895771917], '120.7': [7.624890643424073, 0.2428824272850285, 45.51042612755367, -20.99480184555384, 33.420131213136592], '121.46': [12.178516925713502, -0.069657863938545, 22.790409091994395, -33.11267806382197, 63.376440325371306], '122.66': [2.3651994254538486, 0.1760248580760897, 22.529843484253995, -1.906762871619766, 80.228292414301848], '123.64': [9.783863447395891, -0.11566930180094204, 54.06642538306042, -31.975387420668632, 71.359034296228586], '126.02': [6.530939179008253, -1.2485213240928132, 79.8480364204672, -0.5974871107644978, 215.23218461973107], '126.46': [6.918247567682844, -0.0904213482758367, 82.85905978656525, -3.336735329689547, 68.931188202080577], '126.67': [6.847902480987494, 0.08384122101423408, 66.46392653222873, -6.19324352482134, 52.717120654516577], '126.78': [6.5815120013429285, -0.012061627050329093, 59.38522147340624, -9.81443278201633, 70.769598570442838], '128.5': [7.175255600994746, 0.0, 46.23478135064352, -20.499372864374493, 69.142437037496251], '128.95': [13.190627951917262, 0.2230426824313767, 10.706084033005963, -27.055948686038178, 28.287597873257951], '129.04': [12.37455883837794, -3.197442310920451e-14, 10.145889303770309, -26.738244854858547, 57.510785307158073], '130.04': [7.784682367689651, -0.16927346000325905, 77.2734356064509, -16.232007586183794, 82.704149072020058], '132.64': [12.209590878301325, -0.1103173298594271, 41.088556564483675, -26.534703942466535, 75.326328537821198], '132.97': [6.998539452654741, 5.329070518200751e-15, 85.50403525408791, -7.6688901460978744, 61.742747105311906], '133.3': [7.039349963638979, 0.13315468012035936, 59.95028240096794, -12.175013417478004, 56.23471832310959], '134.58': [10.364736111366947, -0.14158268397732598, 41.71396343323334, -20.830347818971912, 80.789319224315307], '137.85': [2.9018585173480274, 0.08475406001498342, 29.774395453031108, -2.3754031624410334, 99.466970294741941], '139.81': [9.47136183348996, -0.38131021324425873, 68.00925898313982, -25.951431549358034, 124.12015080245834], '141.11': [2.4448422778057646, 0.012797177821513017, 22.775151652274094, -2.9082447574721977, 117.79484081603331], '142.31': [7.4007371156361526, -0.5257447057489717, 81.23312464246744, -2.3190070530474216, 147.52664797892905], '143.17': [7.050737799356986, 0.4398871724775262, 76.31925741610377, -5.530136620183475, 11.247881944700708], '144.69': [7.658606135890955, 0.29897671027246986, 64.00527240407077, -10.932638784639746, 36.738417499115315], '145.34': [7.974248957678623, 0.2828896083738428, 51.29318256901753, -15.739292183786997, 39.502985992785817], '146.32': [8.689558463564328, -1.0658141036401503e-14, 79.87534461674915, -7.433380299086904, 65.829616048136188], '147.41': [13.037413752982426, 0.0, 12.314630590091278, -17.458582974981752, 62.643042256978134], '147.84': [7.955491591845925, 1.2789769243681803e-13, 93.40980535675682, -5.07242583276968, 70.08647094001752], '148.17': [7.447169101284656, -0.08717474388658886, 64.50138781257178, -15.991468356238757, 97.588929383352436], '150.01': [13.911809659907666, 7.105427357601002e-15, 32.5651164158294, -34.1282973741898, 71.00195119209134], '154.57': [5.706705084941407, 8.881784197001252e-15, 70.90736810510047, -1.1547484417869538, 96.176872939169286], '160.11': [8.09903572576955, 0.14262739946996206, 69.61466676244677, -15.326928813055035, 68.672747432012116], '160.87': [15.770265935455667, -0.4096990524155828, 29.355717405928598, -47.539943126384195, 140.01249592495486], '162.6': [8.75610280687271, 0.759009852681654, 84.08197696972923, 11.756916137649597, -33.09952591157321], '163.04': [10.653661565550095, -0.1215730556756256, 65.0781033454911, -29.753723309669432, 103.56030099432054], '171.5': [6.13841492651035, -5.3290705182007514e-14, 68.4082107558627, -0.7289364393841092, 111.19083635891818], '173.46': [20.162169542102575, 0.1008047693190619, 42.42763702704824, -41.27651120473106, 40.830771486505483], '179.1': [7.242290823646554, -0.2708635369388297, 93.73334222731374, 6.627246313857426, 149.43464818297775], '182.36': [4.861237594454997, 0.3187283810017778, 26.73005263395299, 1.5664630142147038, 81.001549323047854], '184.4': [17.763912616126042, 0.039596981277451704, 35.91862743055743, -37.55804325881445, 79.62647655859827], '184.53': [6.673592314135241, 0.009685249447632494, 86.2528660880053, 3.268715422448574, 112.87221839321876], '188.87': [3.8769087860664277, 0.7069079274429519, 38.66339720980348, -3.2365033830847008, 20.340330256028324], '194.08': [13.627330683778522, 0.0899804273547673, 108.10783099113402, -18.92580171306858, 63.177606230729609], '194.41': [9.718008939731444, -0.07763860587859028, 84.69015184977252, -19.76218444021861, 126.48677051068223], '197.88': [16.22859979456179, -0.0023375406393881804, 97.9989225261391, -41.460644567940236, 74.848415640981017], '200.59': [18.015594400351894, -0.6381664443386796, 41.32099341102647, -42.77967724266779, 225.27644900521568], '206.02': [20.05303788906229, 0.40283021054777635, 40.15485576881962, -42.85884477217322, 14.959029586482018], '209.6': [10.64041254752043, -0.4540991340676541, 91.0632073557806, -24.809272876751912, 215.41483452170021], '210.04': [5.4198612072661545, -0.6222444093438213, 61.5951674789901, -3.1084440420533594, 287.82421215830232], '211.12': [19.847739090269236, -0.031351913133505604, 39.2222404850867, -51.97743783544731, 105.72091606832818], '213.29': [13.714732873041845, 0.03229894965366498, 83.0837700403373, -36.924290461394705, 105.20173822234941], '214.92': [8.484167390403696, 0.24275218725396286, 118.80361766277491, 4.367165654465949, 67.835220271092197], '215.25': [11.560892750912657, -1.3322676295501878e-14, 106.78888476870712, -11.354966695341792, 113.30909266166958], '215.79': [14.275837139903967, -0.20806120983108656, 82.13207325924614, -41.885053860689396, 151.75529751582542], '222.3': [11.228361660358498, -0.1295055061158834, 96.92155099918534, -24.45151079323261, 156.27940327883718], '234.24': [29.973860628819935, 0.08428785149153839, 24.55694520274444, -79.78559689540704, 50.974302384459477], '252.7': [18.051349547109176, -0.11461431524277543, 203.08320696053167, -9.771169104000172, 112.83968970592724], '255.41': [18.723562457103526, 0.061946990551192016, 108.78260625136019, -52.512082392070354, 100.87953500653119], '255.95': [32.689085386059276, 0.004738279430483772, 29.88588989991009, -70.12680491143196, 74.519286984739054], '260.3': [16.230339862240317, 0.438651789010315, 174.32679981980215, -12.021805436017225, -0.93164597738368116], '271.15': [10.39828339875268, -0.03561495460914266, 141.7814859282636, -9.264368494658283, 157.74766754162059], '271.48': [12.95516208330703, 0.0, 120.35444358169038, -20.746522428811925, 154.78108162070865], '273.86': [18.74143514333147, -0.22031703621606624, 112.66482983613493, -46.53066179788608, 191.40126370698454], '275.49': [35.17961132805397, 0.1412512470432432, 49.305219279339084, -179.91764841203656, 62.561853710836722], '275.71': [12.666062128346256, 0.17458063382869682, 161.41006227060487, -7.981889984041167, 98.209082099963865], '278.75': [21.097878658817866, -7.105427357601002e-15, 87.65021102598833, -39.809922877874634, 137.49552511895655], '279.83': [9.942549708367334, 0.09637887464810646, 107.53329161917596, -6.788811756275702, 155.70808099544064], '285.26': [16.36514614941205, 0.2896897634541489, 150.6288188146585, -30.305059775923215, 60.616809755108932], '287.43': [14.02995632065966, -0.44965127675897065, 127.6080327814057, -24.419939892451133, 293.12562128740535], '294.71': [21.40959712549121, 0.1990846646047686, 80.23995297623136, -51.146117627020594, 95.561308078882732], '316.85': [6.740040632612922, -2.6645352591003757e-15, 36.84596949669673, 2.6037897809861175, 256.8407464260722]}

    Date = request.GET.get('Date', '')
    _id = request.GET.get('_id', '')
    price = float(Price_get_pricel(_id))
    Date.replace('年', '-')
    Date.replace('月', '-')
    try:
        Date = pd.Period(Date, freq='M')
        Mileage = float(request.GET.get('Mileage', ''))
    except:
        return HttpResponse(json.dumps("Input error, please reenter/输入错误，请重新输入"), content_type='application/json')
    now = time.strftime('%Y-%m-%d', time.localtime(time.time()))
    now = pd.Period(now, freq='M')
    month_gap = int(now - Date)
    if month_gap == 0:
        return HttpResponse(json.dumps("Can not estimate this month/无法估算当月购买车辆"), content_type='application/json')
    if month_gap < 0:
        return HttpResponse(json.dumps("Input error, please reenter/输入错误，请重新输入"), content_type='application/json')
    mpm = Mileage / month_gap
    try:
        intercept_ = dit_price[str(price)][4]
    except:
        return HttpResponse(json.dumps("Can not provide data, please wait for update/暂无数据请静待更新"), content_type='application/json')
    a1 = dit_price[str(price)][0]*Mileage / 22
    a2 = dit_price[str(price)][1]*price
    a3 = dit_price[str(price)][2]*month_gap / 180
    a4 = dit_price[str(price)][3]*mpm
    rePrice = intercept_ + a1 + a2 + a3 + a4
    print(a1, a2, a3, a4)
    print(dit_price[str(price)][0], dit_price[str(price)][1], dit_price[str(price)][2],dit_price[str(price)][3])
    rePrice = round(price - rePrice, 2)
    re_ = "您的爱车估值为 "+str(rePrice)+"万元（估值结果仅供参考）"
    return HttpResponse(json.dumps(re_), content_type='application/json')

